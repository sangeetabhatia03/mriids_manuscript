---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    fig_caption: true
    latex_engine: pdflatex
title: Estimation of Model Parameters
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "`r Sys.Date()`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  tproj : 84
  twindow : 7
  n.dates.sim : 35
  mobility: !r list(K = 1, pow_N_from = 1, pow_N_to = 1)
  incid: healthmap_wide.csv
  nsamples: 1000  
---


```{r setup, eval = TRUE}

library(dplyr)
library(rstan)
library(mRIIDS)
```

## Read incidence data

```{r incid}
incid <- here::here("data/processed", params$incid) %>%
    readr::read_csv()
trng <- incid[seq_len(params$tproj), ]
trng_dates <- pull(trng, date)
pred_dates <- seq(from = max(trng_dates) + 1,
                  length.out = params$n.dates.sim,
                  by = "1 day")
I0    <- as.matrix(select(trng, -date))
n_loc <- ncol(I0)

```

## Read in other meta-data needed


Read in populations and arrange then in the same order as in the
incidence data.
	
```{r}
centroids <- here::here("data/processed",
                        "centroids.csv") %>%
    read.csv()
distances <- geosphere::distm(cbind(centroids$lon,
                                    centroids$lat))
distances <- as.matrix(distances) 
distvec <- distances[lower.tri(distances)]
```

Also need the populations for estimating flows.

```{r pops}
idx <- mRIIDS:::lower_tri_idx(nrow(distances))
n_from <- centroids$pop[idx[, 1]]
n_to <- centroids$pop[idx[, 2]]

```


## Ebola params
```{r ebpars}
suffix <- paste0(params$tproj, "_", params$twindow, ".rds")
si <- paste0("si_", suffix)
si <- here::here("data/stanfits",
                 si) %>%
    readRDS()
```
## Test model fit

The fitted model has draws from the posterior distribution.
We can use these samples to project forward thus doing either
goodness-of-fit test or predictive modeling.

```{r test_fit, eval = TRUE}


countries <- colnames(select(incid, -date))
r_samples <- purrr::map(countries,
                       ~ readRDS(here::here("data/stanfits",
                                            paste0(.x,
                                                   "_rsamples_",
                                                   suffix))))
gamma_samples <- readRDS(here::here("data/stanfits",
                                    paste0("gamma_samples_",
                                           suffix)))
pstay_samples <- readRDS(here::here("data/stanfits",
                                    paste0("pstay_samples_",
                                           suffix)))

```

We want to use the estimate of R in the window right before we start
projecting as the R for the window over which we project. So we will
just pick out the relevant row from the samples.

```{r}
last_window <- tail(trng_dates, 1)
r_pred <- purrr::map_dfr(r_samples, ~ filter(.x,
                                             date == last_window))
r_pred <- select(r_pred, - (date:var))
```

Now we will sample from the full draw for each parameter of the model.

```{r project, eval = TRUE}
index <- sample(seq_along(gamma_samples),
                params$nsamples)

mobility <- params$mobility
daily_projections <- lapply(index, function(row){
                                     gamma <- gamma_samples[row]
                                     pstay <- pstay_samples[row]
                                     R_posterior <- r_pred[, row]
                                     R_posterior <- matrix(R_posterior,
                                                           ncol = ncol(I0),
                                                           nrow = 1)
                                     mobility$pow_dist <- gamma
                                     flowmat <- mRIIDS:::flow_matrix(distvec,
                                                            n_from,
                                                            n_to,
                                                            place_names = centroids$country,
                                                            model = "gravity",
                                                            mobility)


                                     ## Relative risk
                                     rel_risk <- flowmat / rowSums(flowmat, na.rm=TRUE)

                                     ## matrix characterising the population
                                     ##Â movement between geographical units

                                     pij <- mRIIDS:::probability_movement(rel_risk,
                                                                          pstay)
                                     
                                     out <- mRIIDS:::project(I0,
                                                             R_posterior,
                                                             si,
                                                             pij,
                                                             params$n.dates.sim) 
                                     out <- 
                                      as.data.frame(out) 
                                     
                                     out$date <- pred_dates
                                     out
})


```

```{r weekly, eval = TRUE}

weekly_projections <- purrr::map_dfr(daily_projections,
                                     mRIIDS:::daily.to.weekly) 
projections_distr <- mRIIDS:::projection_quantiles(weekly_projections)

```
And finally write the them out for later validation and testing.

```{r write}
outfile <- paste0("forecasts_",
                  params$tproj,
                  "_",
                  params$twindow,
                  "_",
                  params$n.dates.sim,
                  ".csv")
here::here("data/output",
           outfile) %>%
    readr::write_csv(x = projections_distr,
                     path = .)

```

