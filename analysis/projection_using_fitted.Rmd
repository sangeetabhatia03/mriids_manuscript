---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    fig_caption: true
    latex_engine: pdflatex
title: Estimation of Model Parameters
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "`r Sys.Date()`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  tproj : 84
  twindow : 7
  n.dates.sim : 35
  mobility: !r list(K = 1, pow_N_from = 1, pow_N_to = 1)
  incid: healthmap_wide.csv
  nsamples: 1000  
---


```{r setup, eval = TRUE}

library(dplyr)
library(rstan)
library(mRIIDS)
```

## Read incidence data

```{r incid}
incid <- here::here("data/processed", params$incid) %>%
    readr::read_csv()
trng <- incid[seq_len(params$tproj), ]
trng_dates <- pull(trng, date)
pred_dates <- seq(from = max(trng_dates) + 1,
                  length.out = params$n.dates.sim,
                  by = "1 day")
I0    <- as.matrix(select(trng, -date))
n_loc <- ncol(I0)

```

## Read stan fit object

```{r}
fitobj <- paste0(params$tproj, "_", params$twindow, ".rds")
fit1 <- here::here("data/stanfits", fitobj) %>%
    readRDS(.)
```

## R index matrix 



```{r rindex}
rindex <- paste0("rindex_",
                 params$tproj,
                 "_",
                 params$twindow,
                 ".rds")
rindex <- here::here("data/stanfits",
                     rindex) %>% readRDS()
```

## Ebola params
```{r}
si <- paste0("si_",
             params$tproj,
             "_",
             params$twindow,
             ".rds")
si <- here::here("data/stanfits",
                 si) %>%
    readRDS()
```
## Test model fit

The fitted model has draws from the posterior distribution.
We can use these samples to project forward thus doing either
goodness-of-fit test or predictive modeling.

```{r test_fit, eval = TRUE}

list_of_draws <- rstan::extract(fit1)
r_samples     <- list_of_draws[["R"]]
gamma_samples <- list_of_draws[["gamma"]]
pstay_samples <- list_of_draws[["pstay"]]

```

Distances have been calculated using geosphere package. Read in the 
distance matrix and extract the lower triangle.

```{r}

distances <- here::here("data/processed", "distances.mat") %>%
    read.table(header = FALSE)
distances <- as.matrix(distances) 
distvec <- distances[lower.tri(distances)]

```

Read in populations and arrange then in the same order as in the
distance vector.

```{r}
centroids <- here::here("data/processed",
                        "centroids.csv") %>%
    read.csv()

idx <- mRIIDS:::lower_tri_idx(nrow(distances))
n_from <- centroids$pop[idx[, 1]]
n_to <- centroids$pop[idx[, 2]]

```

```{r project, eval = TRUE}
index <- sample(seq_len(nrow(r_samples)),
                params$nsamples)

mobility <- params$mobility
daily_projections <- lapply(index, function(row){
                                     gamma <- gamma_samples[row]
                                     pstay <- pstay_samples[row]
                                     R_posterior <- apply(rindex, c(1, 2),
                                                          function(i) r_samples[row, i])
                                     mobility$pow_dist <- gamma
                                     flowmat <- mRIIDS:::flow_matrix(distvec,
                                                            n_from,
                                                            n_to,
                                                            place_names = centroids$country,
                                                            model = "gravity",
                                                            mobility)


                                     ## Relative risk
                                     rel_risk <- flowmat / rowSums(flowmat, na.rm=TRUE)

                                     ## matrix characterising the population
                                     ##Â movement between geographical units

                                     pij <- mRIIDS:::probability_movement(rel_risk,
                                                                          pstay)
                                     
                                     out <- mRIIDS:::project(I0,
                                                             R_posterior,
                                                             si,
                                                             pij,
                                                             params$n.dates.sim) 
                                     out <- 
                                      as.data.frame(out) 
                                     
                                     out$date <- pred_dates
                                     out
})


```

```{r weekly, eval = TRUE}

weekly_projections <- purrr::map_dfr(daily_projections,
                                     mRIIDS:::daily.to.weekly) 
projections_distr <- mRIIDS:::projection_quantiles(weekly_projections)

```
And finally write the them out for later validation and testing.

```{r write}
outfile <- paste0("forecasts_",
                 params$tproj,
                 "_",
                 params$twindow,
                 ".csv")
here::here("data/output",
           outfile) %>%
    readr::write_csv(x = projections_distr,
                     path = .)

```

