---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: Visualization of forecasts
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  tproj : !r c(84, 126)
  twindow : 7
  incid : healthmap_wide.csv
  n.dates.sim : 35
  place: Guinea
---

```{r setup, eval = TRUE}
library(dplyr)
library(purrr)
library(ggplot2)
```
Read in the projections output.

```{r forecasts}
infiles <- paste0("forecasts_",
                    params$tproj,
                    "_",
                    params$twindow,
                    "_",
                    params$n.dates.sim,
                    ".csv")
names(infiles) <- paste0(params$tproj,
                           "_",
                           params$twindow,
                           "_",
                           params$n.dates.sim
                           )
forecasts <- map_dfr(infiles, ~ readr::read_csv(here::here("data/output",
                                                             .x)),
                     .id = "parameters") %>%
    filter(country == params$place)


```

Read in R estimates.

```{r restim}
## "Guinea_rsamples_539_49.rds"
infiles <- here::here("data/stanfits",
                      paste0(params$place,
                             "_rsamples_",
                             params$tproj,
                             "_",
                             params$twindow,
                             ".rds"))

names(infiles) <-  paste0(params$tproj,
                          "_",
                          params$twindow)
                          

restim <- map_dfr(infiles, readRDS, .id = "parameters")
```

Read in the incidence.

```{r incid}
incid <- incid <- here::here("data/processed",
                    params$incid) %>%
    readr::read_csv() %>%
    select(date, params$place) %>%
    mRIIDS:::daily.to.weekly(.)

incid <- rename(incid,
                "incidence" = params$place)

incid$date <- as.Date(incid$date)
```

Finally plot everything.

```{r forecastsplot}
p <- ggplot()
p <- p + geom_point(data = incid,
                    aes(date, incidence),
                    col = "blue")
## plot projections on top
p <- p + geom_ribbon(data = forecasts,
                     aes(x = date,
                         ymin = ymin,
                         ymax = ymax,
                         fill = parameters),
                     alpha = 0.3)
p <- p + geom_line(data = forecasts,
                     aes(x = date,
                         y = y,
                         col = parameters))

p <-  p + theme_classic()

```

Plot 2. First let us find the quantiles for each set of samples.
```{r qu}
r_quantiles <- select(restim, date, parameters)
df <- data.frame()
for (i in seq_len(nrow(restim))) {
    qntls <- quantile(restim[i, -(1:4)], c(0.025, 0.50, 0.975))
    df <- rbind(df, qntls)
}
r_quantiles <- cbind(r_quantiles, df)
```

```{r rplot}
p2 <- ggplot()
p2 <- p2 + geom_line(data = r_quantiles,
                     aes(x = date,
                         y = `50%`,
                         col = parameters))

p2 <- p2 + geom_ribbon(data = r_quantiles,
                       aes(x = date,
                           ymin = `2.5%`,
                           ymax = `97.5%`,
                           fill = parameters),
                       alpha = 0.3)
p2 <-  p2 + theme_classic()
```

Finally, write it out with a common legend.

```{r save}
prefix <- paste0(params$tproj,
                 collapse = "_")
outfile <- here::here("data/output",
                      paste0(prefix, ".png"))
ggpubr::ggarrange(p,
                  p2,
                  ncol = 1,
                  nrow = 2,
                  common.legend = TRUE,
                  legend="bottom") %>%
    ggpubr::ggexport(filename = outfile)
```
