---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: Visualization of forecasts
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  tproj : !r c(21, 49, 77, 105, 133, 161, 189, 217, 245, 273, 301, 329, 357, 385, 413)
  twindow : 14
  incid : data/processed/20122018_promed_loglinear_weekly.csv
  n.dates.sim : 28
  place: GIN
  maxtproj: 637
---

```{r setup, eval = TRUE}
library(dplyr)
library(purrr)
library(ggplot2)
library(scales)

```
## Real-time R estimates

Read in R estimates.

```{r projections-viz-fixed-country-3, eval = TRUE}

infiles <- here::here("data/stanfits",
                      paste0(params$place,
                             "_rquantiles_",
                              params$tproj,
                             "_",
                             params$twindow,
                             ".rds"))

names(infiles) <-  paste0(params$tproj,
                          "_",
                          params$twindow)
                          
rused <- map(infiles, ~ readRDS(.x))
## Repeat the last row over the projection window.
rused <- map(rused,
             ~ slice(.x,
                     rep(n(),
                         each = params$n.dates.sim)))

## Fix the dates.
rused <- map(rused,
             ~ mutate(.x,
                      date = seq(from = .x$date[1],
                                 by = "1 day",
                                 length.out = params$n.dates.sim)))
## And now put them back together.
rused <- bind_rows(rused, .id = "parameters")

## Make sure date is actually date
rused$date <- lubridate::ymd(rused$date)

```

##Â Observed and projected incidence

Read in the weekly incidence in tall form. 

```{r projections-viz-fixed-country-5 }

incid <- here::here(params$incid) %>%
    readr::read_csv() %>%
    filter(country == params$place)

incid <- filter(incid,
                date <= max(rused$date) + 14)

```

Read in the projections output.

```{r projections-viz-fixed-country-2 }

infiles <- paste0("forecasts_",
                    params$tproj,
                    "_",
                    params$twindow,
                    "_",
                    params$n.dates.sim,
                    ".csv")
names(infiles) <- paste0(params$tproj,
                           "_",
                           params$twindow,
                           "_",
                           params$n.dates.sim
                           )
forecasts <- map_dfr(infiles,
                     ~ readr::read_csv(here::here("data/output",
                                                  .x)),
                     .id = "parameters") %>%
    filter(country %in% params$place)
 

```

Finally plot everything.

```{r projections-viz-fixed-country-6 }
p <- ggplot()
p <- p + geom_point(data = incid,
                    aes(date,
                        incid,
                        col = interpolated))
##                    col = "blue")
## plot projections on top
p <- p + geom_ribbon(data = forecasts,
                     aes(x = date,
                         ymin = ymin,
                         ymax = ymax,
                         group = parameters
                         ),
                     fill = "gray45",
                     alpha = 0.3)
p <- p + geom_line(data = forecasts,
                     aes(x = date,
                         y = y,
                         group = parameters),
                         col = "gray3")

p <- p + theme_classic()
p <- p + xlab("") + ylab("Weekly Incidence")
p <- p +
    scale_x_date(date_breaks = "3 month",
                 labels = date_format("%b %Y"))

```



Plot 2. 

```{r projections-viz-fixed-country-4, eval = TRUE}
preal <- ggplot()
preal <- preal + geom_line(data = rused,
                        aes(x = date,
                            y = `50%`,
                            group = parameters),
                            col = "gray")
preal <- preal + geom_ribbon(data = rused,
                             aes(x = date,
                                 ymin = `2.5%`,
                                 ymax = `97.5%`,
                                 group = parameters
                                 ),
                             alpha = 0.3)
preal <- preal + geom_hline(yintercept = 1,
                            linetype = "dashed")
preal <- preal + theme_classic()
preal <- preal + xlab("") + ylab("R")
preal <- preal +
    scale_x_date(date_breaks = "3 month",
                 labels = date_format("%b %Y"))
## Force x-axis to begin from the time we have incidence date
## so that maps are better aligned.
preal <- preal + expand_limits(x = min(incid$date))
```


## Retrospective R


```{r projections-viz-fixed-country-7}
rretro <- here::here("data/stanfits",
                      paste0(params$place,
                             "_rquantiles_",
                              params$maxtproj,
                             "_",
                             params$twindow,
                             ".rds")) %>%
    readr::read_rds()

rretro$date <- lubridate::ymd(rretro$date)

```


```{r projections-viz-fixed-country-8, eval = TRUE}
pretro <- ggplot()
pretro <- pretro + geom_line(data = rretro,
                             aes(x = date,
                                 y = `50%`),
                             col = "gray")
pretro <- pretro + geom_ribbon(data = rretro,
                               aes(x = date,
                                   ymin = `2.5%`,
                                   ymax = `97.5%`
                                   ),
                               alpha = 0.3)
pretro <- pretro + geom_hline(yintercept = 1,
                              linetype = "dashed")
pretro <- pretro + theme_classic()
pretro <- pretro + xlab("") + ylab("R")
pretro <- pretro +
        scale_x_date(date_breaks = "3 month",
                 labels = date_format("%b %Y"))

```


Finally, write it out with a common legend.

```{r projections-viz-fixed-country-9, eval = TRUE}
prefix <- paste0(params$tproj,
                 collapse = "_")
outfile <- here::here("data/output/figures",
                      paste0(params$place,
                             "_",
                             prefix,
                             "_",
                             params$twindow,
                             "_",
                             params$n.dates.sim,
                             ".png"))
ggpubr::ggarrange(p,
                  preal,
                  pretro,
                  labels = "AUTO",
                  ncol = 1,
                  nrow = 3,
                  widths = c(1, 1, 1),
                  heights = c(2, 1, 1),
                  common.legend = TRUE) %>%
    ggpubr::ggexport(filename = outfile,
                     res = 144,
                     width = 960,
                     height = 960)
```
