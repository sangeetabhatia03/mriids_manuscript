---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: false
    fig_caption: true
    latex_engine: pdflatex
title: Comparison of incidence data from ProMED, HealthMap and WHO
author:
- name: Sangeeta Bhatia
  affiliation: Imperial College London
abstract: 
keywords: 
date: "`r Sys.Date()`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  ofinterest: !r c("GIN", "LBR", "SLE")
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=14, fig.height=7, echo=FALSE, warning=FALSE, message=FALSE, fig.path = "figures/")
```

```{r setup, echo = FALSE}
library(ggplot2)
library(ggthemes)
library(dplyr)
library(EpiEstim)
library(purrr)

```

# Color Scale

```{r colscale}
color_scale <- c("HealthMap" = "#000000",
                 "WHO" = "#E69F00",
                 "ProMED" = "#56B4E9")

```

# WHO data 

```{r whoread}
who_bycountry <- here::here("data/processed",
                            "who_bycountry.csv") %>%
    readr::read_csv() 
    
colnames(who_bycountry) <- c("date",
                             "GIN",
                             "LBR",
                             "SLE")

## Weekly Trend
who_weekly <- mRIIDS:::daily.to.weekly(who_bycountry)    
who_weekly <- tidyr::gather(who_weekly,
                            country,
                            incid,
                            -date)
who_weekly$interpolated <- FALSE
who_weekly$date <- lubridate::ymd(who_weekly$date)

## Cumulative
who_cumulative <- mutate_if(who_bycountry,
                            is.numeric,
                            cumsum) %>%
    tidyr::gather(country, cases, -date) %>%
    select(country, date, cases)

## For stacking with ProMED and HM data
## that we will read in tall format
who_tall <- tidyr::gather(who_bycountry,
                          country,
                          incid,
                          -date)
who_tall$interpolated <- FALSE



```
# Comparison of cumulative cases

The cumulative cases are extracted as sum of confirmed and
suspected cases from ProMED/HealthMap data streams.

```{r cumcomp}

pm_cumulative <- here::here("data/processed",
                                "19022019_promed_loglinear_cumulative.csv") %>%
    readr::read_csv() 

pm_cumulative$country <- countrycode::countrycode(pm_cumulative$country,
                                                      'country.name',
                                                      'iso3c')

pm_cumulative <- filter(pm_cumulative,
                            country %in% params$ofinterest) 

hm_cumulative <- here::here("data/processed",
                                "19022019_healthmap_loglinear_cumulative.csv") %>%
    readr::read_csv()

hm_cumulative$country <- countrycode::countrycode(hm_cumulative$country,
                                                  'country.name',
                                                  'iso3c')

hm_cumulative <- filter(hm_cumulative,
                        country %in% params$ofinterest) 


```



```{r cum_incid_viz, eval = TRUE}
all_cumulative <- list(WHO = who_cumulative,
                       HealthMap = hm_cumulative,
                       ProMED    = pm_cumulative) %>%
    bind_rows(.id = "Source")


p_cumulative <- 
    ggplot(all_cumulative,
           aes(date,
               cases,
               color = Source
               )) +
    geom_point() 

p_cumulative <- p_cumulative +
    theme_classic()
    
p_cumulative <- p_cumulative +    
    facet_wrap(country ~.,
               scales = "free_y",
               strip.position = "top",
               nrow = 3) +
    scale_colour_manual(values = color_scale)
    

p_cumulative <- p_cumulative +
    theme(legend.position = "none")

p_cumulative <- p_cumulative +
    xlab("") +
    ylab("Cumulative Incidence")


p_cumulative
```


## Comparison of daily incidence trends


```{r hmread, echo = FALSE}
hm_daily <- here::here("data/processed",
                        "19022019_healthmap_loglinear_tall.csv") %>%
    readr::read_csv() %>%
    filter(country %in% params$ofinterest)


pm_daily <- here::here("data/processed",
                       "19022019_promed_loglinear_tall.csv") %>%
    readr::read_csv() %>%
    filter(country %in% params$ofinterest)    



```


```{r daily_incid_viz, eval = TRUE}
all_daily <- list(WHO = who_tall,
                   HealthMap = hm_daily,
                   ProMED    = pm_daily) %>%
    bind_rows(.id = "Source")



p_daily <- 
    ggplot(all_daily,
           aes(date,
               incid,
               color = Source)) +
    geom_point() 

p_daily <- p_daily +
    theme_classic()

p_daily <- p_daily +
    facet_wrap(country ~.,
               scales = "free_y",
               strip.position = "top",
               nrow = 3) +
    scale_colour_manual(values = color_scale)

p_daily <- p_daily +
    theme(legend.position = "none")

p_daily <- p_daily +
    xlab("") +
    ylab("Daily Incidence")


p_daily

```


## Comparison of weekly incidence trends

```{r}
hm_weekly <- here::here("data/processed",
                        "19022019_healthmap_loglinear_weekly.csv") %>%
    readr::read_csv() %>%
    filter(country %in% params$ofinterest) 


pm_weekly <- here::here("data/processed",
                        "19022019_promed_loglinear_weekly.csv") %>%
    readr::read_csv() %>%
    filter(country %in% params$ofinterest) 



```


```{r weekly_incid_viz, eval = TRUE}


all_weekly <- list(WHO = who_weekly,
                   HealthMap = hm_weekly,
                   ProMED    = pm_weekly) %>%
    bind_rows(.id = "Source")

p_weekly <- 
    ggplot(all_weekly,
           aes(date, incid, color = Source)) +
    geom_point()
p_weekly <- p_weekly +
    theme_classic()
p_weekly <- p_weekly +
        facet_wrap(country ~.,
               scales = "free_y",
               strip.position = "top",
               nrow = 3) +
    scale_colour_manual(values = color_scale)

p_weekly <- p_weekly +
    theme(legend.position = "none")
p_weekly <- p_weekly +
    xlab("") +
    ylab("Weekly Incidence")



p_weekly 

```





## Correlation between the incidence data

```{r incid_corrplot, eval = TRUE}
library(zeallot)
## c(who, pm, hm) %<-%  map(list(who_weekly,
##                               pm_weekly,
##                               hm_weekly),
##                          ~ tidyr::gather(.x,
##                                          country,
##                                          incid,
##                                          -date))

## Get week of year for each date after discarding the
## interpolated column. The goal is to get a df of
## weekly incidence so that we can compute correlation.
c(who_weekly$week,
  pm_weekly$week,
  hm_weekly$week) %<-%
    map(list(who_weekly[, -4],
             pm_weekly[, -4],
             hm_weekly[, -4]),
        ~ paste(lubridate::year(.x$date),
                lubridate::week(.x$date),
                sep = "-"))

hm_who_pm_incid <- inner_join(who_weekly,
                              hm_weekly,
                              by = c("week",
                                     "country")) %>%
              select(country, week, incid.x, incid.y) %>%
              rename("WHO" = `incid.x`,
                     "HealthMap" = `incid.y`) %>%
              inner_join(pm_weekly, by = c("week", "country")) %>%
              rename("ProMED" = `incid`) %>%
              select(WHO, ProMED, HealthMap)


M <- Hmisc::rcorr(as.matrix(hm_who_pm_incid),
                  type = "pearson")

```

## Estimating Reproduction number from WHO and Healthmap Data

# Parameters for Ebola

Culled from literature.

```{r ebola_params, eval = TRUE}

mean_SI     <- 14.2
CV_SI       <- 9.6 / 14.2
SItrunc     <- 40
SI_Distr    <- sapply(0:SItrunc, function(e) EpiEstim::DiscrSI(e, mean_SI, mean_SI * CV_SI))
SI_Distr    <- SI_Distr / sum(SI_Distr)
time_window <- 7 * 2

```

```{r restim}
all_R <- split(all_daily, list(all_daily$Source,
                                all_daily$country)) %>%
    map_dfr(function(x) {
        I <- x$incid
        start <- 2:(nrow(x) - time_window)
        end <- start + time_window
        res <- EpiEstim::EstimateR(I,
                                   T.Start = start,
                                   T.End = end,
                                   method   = "NonParametricSI",
                                   SI.Distr = SI_Distr,
                                   plot     = FALSE ,
                                   CV.Posterior = 1 ,
                                   Mean.Prior   = 1 ,
                                   Std.Prior    = 0.5)
        res$R$date <- x$date[end]
        res$R
                                   
    },
    .id = "source.country")


all_R <- tidyr::separate(all_R,
                         source.country,
                         into = c("Source", "country"),
                         extra = "merge",
                         fill = "left")


```   


```{r restimviz}

p <- ggplot()
p <- p + geom_ribbon(data = all_R,
                     aes(x = date,
                         ymin = `Quantile.0.025(R)`,
                         ymax = `Quantile.0.975(R)`,
                         fill = Source),
                     alpha = 0.3)
p <- p + geom_line(data = all_R,
                   aes(
                       x = date,
                       y = `Median(R)`,
                       color = Source))
p <- p + theme_classic()
p <- p + facet_wrap(country ~.,
                    scale = "free_y",
                    strip.position = "top",
                    nrow = 3)
p <- p + theme(legend.position = "none")
p <- p + xlab("")
p <- p +
    scale_colour_manual(values = color_scale) +
    scale_fill_manual(values = color_scale) 
p <- p +
    geom_hline(yintercept = 1,
               linetype = "dashed")

p

```

The graphs show that the estimates from the three different sources
closely track each other. Here's another way to visualise this.
As the above graphs indicates, estimates of the reproduction number
from ProMed, HealthMap and WHO data are highly correlated (correlation
coefficient = 0.76, 95% CI = (0.74, 0.78)).

```{r all6}
library(ggpubr)
p_all <- ggarrange(p_daily,
                   p,
                   nrow = 1,
                   ncol = 2,
                   labels = "AUTO",
                   legend = "bottom",
                   common.legend = TRUE)

ggexport(p_all,
         filename = "figures/who_hm_promed_compare.png"
         )

```
