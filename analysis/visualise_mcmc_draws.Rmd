---
output: 
pdf_document:
citation_package: natbib
keep_tex: false
fig_caption: true
latex_engine: pdflatex
title: 
author:
- name: Sangeeta Bhatia
affiliation: Imperial College London
abstract: 
keywords: 
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
spacing: double
bibliography: 
biblio-style: apsr
endnote: no
params:
  incid : healthmap_wide.csv
  tproj : 364
  twindow : 28
  nsamples : 500
---

```{r setup, eval = TRUE}
library(dplyr)
library(purrr)
library(ggplot2)
library(ggthemes)
```
# Read in the incidence 

```{r incid}
incid <- here::here("data/processed",
                    params$incid) %>%
    readr::read_csv()
trng_date <- incid$date[seq_len(params$tproj)]

```

## Read stan fit object

```{r}
fitobj <- paste0(params$tproj, "_", params$twindow, ".rds")
fit1 <- here::here("data/stanfits", fitobj) %>%
    readRDS(.)
```

Extract samples.

```{r test_fit, eval = TRUE}

list_of_draws <- rstan::extract(fit1)
r_samples     <- list_of_draws[["R"]]
idx <- sample(seq_len(nrow(r_samples)), params$nsamples)
r_samples <- r_samples[idx, ]

```
We will need the rindex object to map the variables we have used.



```{r rindex}
rindex <- paste0("rindex_",
                 params$tproj,
                 "_",
                 params$twindow,
                 ".rds")
rindex <- here::here("data/stanfits",
                     rindex) %>% readRDS()

rindex_df <- as.data.frame(rindex)
colnames(rindex_df) <- colnames(select(incid, -date))
```

Attach dates to the rindex data frame so we will know what variables 
are for which date.


```{r}
rindex_df$date <- trng_date

```
Each column in r_samples is a set of draws for a variable. The column
number identifies the variable number.

```{r}
rindex_df <- tidyr::gather(rindex_df, country, var, -date)
```

Now go over each row of this data frame, look at the var variable,
grab the corresponding column from r_samples and affix it to this row.

```{r reshape}
samples <- purrr::pmap(rindex_df, ~ r_samples[, ..3])
samples <- do.call(rbind, samples)
colnames(samples) <- paste0("sample_", seq_len(ncol(samples)))
rsamples <- cbind(rindex_df, samples)
rsamples <- tidyr::gather(rsamples, sample, val, - (date:var))
```


## Ebola params
```{r}
si <- paste0("si_",
             params$tproj,
             "_",
             params$twindow,
             ".rds")
si <- here::here("data/stanfits",
                 si) %>%
    readRDS()
```
Also estimate R using epiestim.

```{r epiestim}
## start <- 2:(params$tproj)
start <- seq(from = 2, to = params$tproj, by = params$twindow)
end <- start + params$twindow
end.dates <- incid[end, "date"]
r.estim <- select(incid, -date) %>%
    map(function(x) {
    res <- EstimateR(
      x,
      T.Start = start,
      T.End = end,
      method = "NonParametricSI",
      SI.Distr = si,
      plot = FALSE,
      CV.Posterior = 1,
      Mean.Prior = 1,
      Std.Prior = 0.5
    )
    res$R <- cbind(res$R, date = end.dates)
    res$R
    })

r.estim <- bind_rows(r.estim, .id = "country")
```
```{r viz}
rsamples$date <- as.Date(rsamples$date)

p <- ggplot(rsamples, aes(date, val)) +
    geom_point(alpha = 0.1) +
    facet_wrap(~country, nrow = 3, scales = "free_y") 


p <- p + geom_line(data = r.estim,
                   aes(date, `Mean(R)`), col = "blue")

p <- p + geom_ribbon(data = r.estim,
                     aes(
                         x = date,
                         ymin = `Quantile.0.025(R)`,
                         ymax = `Quantile.0.975(R)`
                     ),
                     fill = "blue",
                     alpha = 0.2,
                     inherit.aes = FALSE,
                     group = 1)
      
p <- p +  theme_classic()
outfile <- paste0("r_",
                  params$tproj,
                  "_",
                  params$twindow,
                  ".png")

ggsave(here::here("data/output", outfile),
       p)
```
