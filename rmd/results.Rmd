# Results {#results}

```{r echo = FALSE}
library(captioner)
si_fig_nums <- captioner(prefix = "(SI) Figure")
fig_nums <- captioner(prefix = "Figure")
tab_nums <- captioner(prefix = "Table")
```


```{r echo = FALSE, warning = FALSE}
## Need to define stuff before we can use it.
rcorrcite <- si_fig_nums(name = "rcorr",
                       display = "cite")
rcorrcap <- si_fig_nums(name = "rcorr",
                     caption = "R estimates from ProMED,
HealthMap and WHO data when using different time windows. (Top) Time
 window of 14 days. (Bottom) Time window of 42 days.
The orange line depicts the identity function.")

```

## Processing ProMED/HealthMap data feed

We used a set of curated ProMED and HealthMap records on the human 
cases of Ebola in West Africa. 
The dates in the feeds ranged from March 2014 to October 2016.
The data set recorded the cumulative number of suspected/confirmed
cases and suspected/confirmed deaths by country at various dates
in this period. We derived the country specific daily and 
weekly incidence time series from these data after the 
following data cleaning and pre-processing:

+ We first extracted the total case
counts as a sum of suspected and confirmed cases. 
+ Each unique record 
in ProMED/HealthMap data is associated with a unique alert id.  Where
multiple records were associated with the same alert id, we merged
them by assigning the median of the case numbers to the record. In
some instances, cumulative case count was inconsistent in that it
failed to be monotonically increasing. Any record of a 
cumulative case number lower than a previous record was removed.
+ Finally, cumulative incidence on days with no records was
filled in using linear or log-linear interpolation. 

Further details and result of 
each step of the pre-processing of Promed and 
Healthmap data are presented in the supplementary text.

## Data collated by WHO

We used the incidence data collated by the WHO during the West 
African Ebola epidemic made available by [@garske20160308], 
later referred to as the ``WHO data'' in the interest of brevity. 
The cleaned version of the WHO data consisted of cases reported
between December 2013 and October 2015 in three most affected
countries - Guinea, Sierra Leone and Liberia. The location of
residence of cases was geo-coded to the second administrative level. 
We aggregated the WHO data to national level to match the spatial
resolution of ProMED and HealthMap that were only available at the 
country level.


## Comparison of incidence trends from different sources

```{r echo = FALSE, warning = FALSE}
incidrcite <- fig_nums(name = "incidrcompare",
                       display = "cite")
incidrcap <- fig_nums(name = "incidrcompare",
                      caption = "Comparison of daily incidence
trends and R estimates from ProMED, HealthMap and WHO data (A) Daily
incidence series derived from ProMED (blue), HealthMap (black) and WHO data (orange). The interpolated points for ProMED and HealthMap are shown in lighter shade of blue and black respectively. WHO data were aggergated to country level. (B) The mean
time-varying reproduction number estimated using the WHO data, ProMED (blue) and
HealthMap (black) data. The shaded region depicts the 95% CrI for the R estimates.
The reprodcution number was estimated using EpiEstim with a time window of 28 days.")

```

Incidence time series were computed from ProMED, HealthMap and WHO
data (see Methods section) for the three mainly affected countries, 
Guinea, Liberia and Sierra Leone, and are shown in 
`r incidrcite`.There were substantial differences between the
incidence 
time series derived from the three data sources, particularly at the 
peak of the epidemic. There may be multiple reasons underpinning such
discrepancy, including potential variability in digital surveillance 
reporting to during the course of the epidemic. It is also worth 
highlighting that the WHO data used here are an extensively cleaned 
version of the data collected during the epidemic [@who2014ebola], 
[@team2015west], published more than a year after the epidemic was declared to be 
over. However, despite these discrepancies, the weekly incidence
derived from ProMED and HealthMap was moderately to highly correlated with that
reported by WHO later (Pearson's 
correlation coefficient aggregated across the three countries 
0.44 and 0.74 respectively, p value < 0.001).

To broadly assess the extent to which such discrepancies in incidence 
would impact the quantification of transmissibility throughout the 
epidemic, we estimated the time-varying transmissibility, measured by 
the reproduction number $R_t$ (the average number of secondary cases 
infected by each individual infected at time $t$),
using the incidence from each of the three data sources `r
incidrcite`. $R_t$ was estimated independently for each country using 
the R package EpiEstim [@cori2013new] with a sliding time window of 4
weeks. There were substantial differences in the estimates of the $R_t$ 
according to the incidence data source used (Figure 1B). 
The correlation between the mean R estimates on sliding 4-week windows 
from ProMED or HealthMap data with the estimates from WHO data varied 
from weak (0.27, between reproduction number from WHO and ProMED in 
Guinea ) to very strong (0.81, between reproduction number from WHO
and HealthMap in Sierra Leone).




```{r echo = FALSE, fig.cap = incidrcap, fig.align = "center"}
knitr::include_graphics("ms-figures/who-hm-promed-comparison-20-1.png")
```

In the following, we use ProMED data as our main data source, 
unless otherwise specified. 


## Short term projections

To project incidence at time $t$ in location $j$ ($I_{j, t}$), 
we fitted a spatially explicit branching process model to the daily
incidence in all locations up to 
$t - 1$, using an extension of the renewal equation as the likelihood 
[@fraser2007estimating]:

\begin{equation}
I_{j, t} \sim Poisson\left(\sum_{i = 1}^n\left({p_{i \rightarrow j} R_{i, t}
\sum^{s = 1}^t{I_{i, t - s} \omega_s}}\right)\right)
(\#eq:model)
\end{equation}
where the matrix $p_{i \rightarrow j}$ characterises the spatial
spread between locations $i$ and $j$ based on a gravity model
[@zipf1946p]. $R_{i, t}$ (the reproduction number) reflects 
transmissibility in location $i$ at time $t$, and $\omega$ is the
typical infectiousness profile of a case over time after infection 
(see Methods for details).


```{r echo = FALSE, warning = FALSE}
g28cite <- fig_nums(name = "promed28",
                    display = "cite")

who28cite <- fig_nums(name = "who28",
                      display = "cite")

```

The ability of the model to robustly predict future outbreak
trajectory depended on the 
data source (see Figures 2, 3 and 4  for ProMED HealthMap and WHO data respectively)
as well as on  the time window used for inference and the time horizon
used for predictions (alternative time window in SI.XX). Overall,
using a 2- week time window for inference based on ProMED data, and
projecting ahead for 4 weeks, 53.3% of observed incidence across all 
countries in the forecast horizon were included in the 95% credible 
intervals (95%CrI).  Using data from Healthmap and  WHO respectively,  
this figure was XXX% and 69.5%.

As expected,  the robustness of projections decreased over the 
projection horizon (Figure 5). In the first week of the projection
window, 73.1% of observed values (across the three countries) were 
within the 95%CrI. The mean value of the relative mean absolute error
(see Methods for details) in this period was XXX (Inter Quartile
Range, IQR: 0.18 - 0.69), suggesting that on average our central one 
week ahead predictions were about a third off either way of the 
observations. To further assess the potential tendency of our model 
to systematically under or over predict observations, we used a bias 
measure ranging from -1 for a model which always under-predicts, to 
1 for a model which always over-predicts (see Methods). 
The median bias for one-week ahead projections was 0.03 (IQR -0.25 -
0.4) indicating little systematic bias. 



We also estimated retrospective transmissibilty using all the available 
data. The retrospective estimates of R agree reasonably well with the 
real time estimates of R (bottom two panels `r g28cite`). The model is
able to capture well the broad trends in the progress of the epidemic 
within each country (top panel `r g28cite`) as well as the
spatio-temporal spread (`r mapcite`). 
The forecasts and R estimates using WHO data are shown in `r who28cite`.

The results presented in the main text were obtained using a time 
window of 14 days. Results from the model using other time windows and 
projection horizon are presented in the supplementary text.

```{r figcaps, echo = FALSE}
g28cap <- fig_nums(name = "promed28",
                   caption = "Observed and predicted
incidence, and reproduction number estimates from ProMED data.
The top panel shows the weekly incidence derived from ProMED
data and the 4 weeks incidence forecast on log scale.
The solid dots represent the observed weekly incidence where
the light blue dots show
weeks for which at least one data point was obtained using
interpolation. The projections are made over 4 week windows, based on the
reproduction number estimated in the previous 2 weeks.
The middle figure in each panel shows the reproduction number
used to make projections over each 4 week projection window.
The bottom figure shows the effective reproduction number estimated
retrospectively using the full dataset up to the end.
In each case, the solid gray line is the median
estimate and the shaded region represents the 95% CrI.")


who28cap <- fig_nums(name = "who28",
                   caption = "Observed and predicted
incidence, and reproduction number estimates from the WHO data.
The top panel shows the weekly incidence derived from the WHO
data and the 4 weeks incidence forecast on log scale.
The solid dots represent the observed weekly incidence.
The projections are made over 4 week windows, based on the
reproduction number estimated in the previous 2 weeks.
The middle figure in each panel shows the reproduction number
used to
make projections over each 4 week projection window.
The bottom figure shows the effective reproduction number estimated
retrospectively using the full dataset up to the end.
In each figure, the solid gray line is the median
estimate and the shaded region represents the 95% CrI.")

```

```{r echo = FALSE, fig.cap = g28cap, fig.align = "center"}
knitr::include_graphics("ms-figures/promed_projections-viz-fixed-country-14-1._14.png")
```



```{r echo = FALSE, fig.cap = who28cap, fig.align = "center"}
knitr::include_graphics("ms-figures/who_projections-viz-fixed-country-14-1._14.png")
```


```{r echo = FALSE, fig.cap = mapcap, fig.align = "center"}
knitr::include_graphics("ms-figures/promed_mli_nonzero.png")
```

```{r echo = FALSE, warning = FALSE}
parscite <- fig_nums(name = "pstayandgamma",
                     display = "cite")

parscap <- fig_nums(name = "pstayandgamma",
                    caption = "Estimates of mobility model parameters 
during the epidemic.
The solid yellow line represents the median obtained using WHO
data and the blue line represents the median using ProMED data.
The shaded regions represent the 95% CrI.")
```
The parameters of the mobility model ($p_{stay}$ and $\gamma$) 
were estimated using the incidence data coupled with the population 
estimates and the 
geographical distances. $p_{stay}$ is the probability
of an individual to stay within a country and $\gamma$ is a measure of
the influence of distance between two locations on the flow between 
them. Both the parameters were 
assumed to be constant for the time frame over which model was fitted 
and across all countries. It is interesting to note that the change in 
parameter estimates over the course 
of the epidemic (`r parscite`) suggests a decreased probability of 
travel across national borders.


```{r echo = FALSE, fig.cap = parscap, fig.align = "center", fig.width = 3.4}
knitr::include_graphics("ms-figures/who_gamma_pstay_over_tproj_14.png")
```




## Model Evaluation 

```{r echo = FALSE, warning = FALSE}
assesscite <- fig_nums(name = "assess", display = "cite")
assesscap <- fig_nums(name = "assess",
                      caption = "Metrics for evaluating model
performance where the projection horizon was 4 weeks.
The y-axis shows (anti-clockwise from top left)
bias, log relative accuracy, relative mean
absolute error and sharpness scores respectively. In the forward
projections, we assumed transmissibility to be constant over the
projection window. be If the 97.5th percentile of the R estimate used
was less than 1, we defined the epidemic to be in the declining phase
during this period. Similarly, if the 2.5th percentile of R was
greater than 1, we defined the epidemic to be in a growing phase.")

proptabcite <- tab_nums(name = "propinci", display = "cite")
proptabcap <- tab_nums(name = "propinci",
                       caption = "Proportion of observed incidence in
95% CrI of the projected incidence.")
```

An intuitive measure of model accuracy is the proportion of
observed values that are contained in the distribution of simulated 
values. `r proptabcite` shows the proportion of observed incidence 
values in the 95% CrI of the simulated trajectories. The model
performance varies depending on the phase of the epidemic and the 
country. In general, the model accuracy is better in the declining 
phase of the epidemic (defined as the window in which the 975th 
percentile of the
posterior distribution of the reproduction number is less than 1). 

In addition to the 
accuracy of the projected incidence, the uncertainty associated 
with the forecasts (e.g., measured by the width of the prediction
interval) is an important indicator of model performance. A 
narrow prediction interval that contains the observed values
is preferable over wide prediction intervals. To asses the 
performance of the model along both these dimensions, 
we used different metrics - bias, sharpness, and relative error,
drawn from the literature. These are explained in detail in the
SI. Briefly, sharpness is a measure of the spread of forecasts with a 
value of 0 indicating perfect agreement across simulated
trajectories. Bias measures the tendency of a model to systematically 
under or over predict. The bias score for a model is 1 if it always 
over-predicts and  -1 if it always under-predicts. 


```{r proponci, echo = FALSE, message = FALSE, fig.cap = proptabcap}
library(magrittr)
here::here("data/processed/promed_propinci_byphase.csv") %>%
    readr::read_csv() %>%
        flextable::flextable(cwidth = 1) 
```

The bias and scores of the model (`r assesscite` A) indicate that in the
growing phase, the model tends to over-predict with the forecasts
becoming less sharp (`r assesscite` B) as the projections are made over
longer time frames. In 
the declining phase (defined similarly as the window in which the 
0.975th R percentile is less than 1), the model tends to 
under-predict.

Across all metrics, there is a strong trend of decreased model
performance as the forecast horizon increases. The bias in forecasts
at week 1 is closer to 0 at every time point. Similarly the forecasts
at week 1 are more sharp (sharpness close to 0) than at week 4. 
The length of the time window used to estimate R did not have a 
significant impact on the model performance.

The choice of time window (2, 4 or 6 weeks) for estimating R
corresponded to a different model. As we estimated a reproduction
number in each time window for each location, a shorter time window 
introduced more parameters in the model. At each point of projection
where more than one model was fitted, we estimated Bayes factor 
[@kass1995bayes] for model comparison using R package bridgesampling 
[@bridgeasampling]. Our analysis suggests that the preference for
increased model complexity changed during the course of the epidemic. 
In the early phase, we did not find strong evidence for using a smaller 
time window (more complex model) while in the later phase, there was 
decisive support for small time window over a longer one. This finding
lends support to the intuition that in an unfolding outbreak, the more 
recent past is a better indicator of the short term future, especially 
in a rapidly changing situation.



```{r assess, echo = FALSE, fig.cap = assesscap, fig.align = "center"}
knitr::include_graphics("ms-figures/forecasts_assess_14.png")
```

